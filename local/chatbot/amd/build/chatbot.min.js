define(["jquery","core/templates"],function(t,e){return{init:function(o){var n=o.userid,c=o.username,a=o.coursename,i=o.credits||0,r=M.util.image_url("logo","local_chatbot");function s(){var e=t("#chatbot-text").val().trim();e&&(i<=0?u("bot",M.str.local_chatbot.outofcredits):(t("#chatbot-text").val(""),u("user",e),function(e){var o=["Understanding your question...","Formulating a response...","Referencing course modules..."],n=t("#chatbot-thinking"),c=0;function a(){c<o.length?(n.text(o[c]),c++,setTimeout(a,1e3)):(n.text(""),e())}a()}(function(){t.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(o){o&&void 0!==o.credits&&(i=o.credits,t("#chatbot-credits").text("Credits remaining: "+i)),u("bot","Hi there"),console.log("Sent to backend",{text:e,userid:n,coursename:a})},"json")})))}function u(o,n){var a="bot"===o?"sid":c;e.render("local_chatbot/message",{sender:o,text:n,sendername:a}).done(function(o){t("#chatbot-messages").append(o),e.runTemplateJS(o);var n=t("#chatbot-messages")[0];n.scrollTop=n.scrollHeight})}e.render("local_chatbot/chatbox",{iconurl:r}).done(function(o){var r,u;t("body").append(o),e.runTemplateJS(o),t("#chatbot-context").text(c+" ("+n+") - "+a),t("#chatbot-credits").text("Credits remaining: "+i),r=t("#chatbot-icon"),u=t("#chatbot-window"),r.on("click",function(){u.toggleClass("hidden")}),t("#chatbot-send").on("click",s),t("#chatbot-text").on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),s())})})}}});
