define(["jquery","core/templates"],function(u,r){return{init:function(t){var s=t.userid,o=t.username,a=t.coursename,i=t.credits||0,t=M.util.image_url("logo","local_chatbot");function n(){var e,o,n,r,c=u("#chatbot-text").val().trim();c&&(i<=0?l("bot",M.str.local_chatbot.outofcredits):(u("#chatbot-text").val(""),l("user",c),e=function(){u.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(t){var e;t&&void 0!==t.credits&&(i=t.credits,u("#chatbot-credits").text("Credits remaining: "+i)),e=function(t,e){l("bot",t||e),console.log("Sent to backend",{text:c,userid:s,coursename:a})},u.ajax({url:M.cfg.wwwroot+"/local/chatbot/chatapi.php",method:"POST",dataType:"json",data:{sesskey:M.cfg.sesskey,message:c},success:function(t){t&&t.reply?e(null,t.reply):t&&t.error?e(t.error):e("Invalid response from server")},error:function(t){t=t.responseText||t.statusText||"Unknown error";e("Error: "+t)}})},"json")},o=["Understanding your question...","Formulating a response...","Referencing course modules..."],n=u("#chatbot-thinking"),r=0,function t(){r<o.length?(n.text(o[r]),r++,setTimeout(t,1e3)):(n.text(""),e())}()))}function l(t,e){r.render("local_chatbot/message",{sender:t,text:e,sendername:"bot"===t?"sid":o}).done(function(t){u("#chatbot-messages").append(t),r.runTemplateJS(t);t=u("#chatbot-messages")[0];t.scrollTop=t.scrollHeight})}r.render("local_chatbot/chatbox",{iconurl:t}).done(function(t){var e;u("body").append(t),r.runTemplateJS(t),u("#chatbot-context").text(o+" ("+s+") - "+a),u("#chatbot-credits").text("Credits remaining: "+i),t=u("#chatbot-icon"),e=u("#chatbot-window"),t.on("click",function(){e.toggleClass("hidden")}),u("#chatbot-send").on("click",n),u("#chatbot-text").on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),n())})})}}});
