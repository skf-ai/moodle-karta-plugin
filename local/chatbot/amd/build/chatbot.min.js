define(["jquery","core/templates"],function(u,r){return{init:function(t){var s=t.userid,o=t.username,c=t.coursename,i=t.credits||0,t=M.util.image_url("logo","local_chatbot");function n(){var e,o,n,r,a=u("#chatbot-text").val().trim();a&&(i<=0?d("bot",M.str.local_chatbot.outofcredits):(u("#chatbot-text").val(""),d("user",a),e=function(){u.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(t){t&&void 0!==t.credits&&(i=t.credits,u("#chatbot-credits").text("Credits remaining: "+i));var t=a,e=function(t,e){d("bot",t||e),console.log("Sent to backend",{text:a,userid:s,coursename:c})};t={session_id:String(s),interaction_id:String(Math.floor(1e9*Math.random())),messages:[{content:t,content_type:"text",created_at:(new Date).toISOString()}],user_property:{},course_id:["111"]},u.ajax({url:"https://hooks.getkarta.ai/api/v1/skf/SidRFS_67aAV4",method:"POST",contentType:"application/json",data:JSON.stringify(t),headers:{Authorization:"Basic "+btoa("SKF_ADMIN:^ffB57rC]1$5")},success:function(t){t&&t.reply?e(null,t.reply):e("Invalid response from server")},error:function(t){t=t.responseText||t.statusText||"Unknown error";e("Error: "+t)}})},"json")},o=["Understanding your question...","Formulating a response...","Referencing course modules..."],n=u("#chatbot-thinking"),r=0,function t(){r<o.length?(n.text(o[r]),r++,setTimeout(t,1e3)):(n.text(""),e())}()))}function d(t,e){r.render("local_chatbot/message",{sender:t,text:e,sendername:"bot"===t?"sid":o}).done(function(t){u("#chatbot-messages").append(t),r.runTemplateJS(t);t=u("#chatbot-messages")[0];t.scrollTop=t.scrollHeight})}r.render("local_chatbot/chatbox",{iconurl:t}).done(function(t){var e;u("body").append(t),r.runTemplateJS(t),u("#chatbot-context").text(o+" ("+s+") - "+c),u("#chatbot-credits").text("Credits remaining: "+i),t=u("#chatbot-icon"),e=u("#chatbot-window"),t.on("click",function(){e.toggleClass("hidden")}),u("#chatbot-send").on("click",n),u("#chatbot-text").on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),n())})})}}});
