define(["jquery","core/templates","local_chatbot/markdown"],function(e,t,o){return{init:function(a){var n=a.userid,s=a.username,r=a.coursename,c=a.credits||0,l=M.util.image_url("logo","local_chatbot"),i="1"===localStorage.getItem("chatbotSuppressed");function d(){var t=e("#chatbot-text").val().trim();if(t)if(c<=0)u("bot",M.str.local_chatbot.outofcredits);else{e("#chatbot-text").val(""),u("user",t);var o,a,s,l,i=(o=["Understanding your question...","Formulating a response...","Referencing course modules..."],a=e("#chatbot-thinking"),s=0,l=setInterval(function(){a.text(o[s]),s=(s+1)%o.length},1e3),function(){clearInterval(l),a.text("")});e.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(o){var a,s;o&&void 0!==o.credits&&(c=o.credits,e("#chatbot-credits").text("Credits remaining: "+c)),a=t,s=function(e,o){u("bot",e||o),i(),console.log("Sent to backend",{text:t,userid:n,coursename:r})},e.ajax({url:M.cfg.wwwroot+"/local/chatbot/chatapi.php",method:"POST",dataType:"json",data:{sesskey:M.cfg.sesskey,message:a},success:function(e){e&&e.reply?s(null,e.reply):e&&e.error?s(e.error):s("Invalid response from server")},error:function(e){var t=e.responseText||e.statusText||"Unknown error";s("Error: "+t)}})},"json")}}function u(a,n){var r="bot"===a?"sidGuru":s;n="bot"===a?o.convert(n):o.escapeHtml(n),t.render("local_chatbot/message",{sender:a,text:n,sendername:r}).done(function(o){e("#chatbot-messages").append(o),t.runTemplateJS(o);var a=e("#chatbot-messages")[0];a.scrollTop=a.scrollHeight})}t.render("local_chatbot/chatbox",{iconurl:l}).done(function(a){var l,u,h;e("body").append(a),t.runTemplateJS(a),e("#chatbot-context").text(s+" ("+n+") - "+r),e("#chatbot-credits").text("Credits remaining: "+c),i||setTimeout(function(){var a,n;e("#chatbot-window").removeClass("hidden"),a="Hello! I'm SidGuru, your academic companion. I can answer questions, clear doubts, and even summarize course content. How may I assist you today?",n="sidGuru",t.render("local_chatbot/message",{sender:"bot",text:"",sendername:n}).done(function(n){e("#chatbot-messages").append(n),t.runTemplateJS(n);var s=e("#chatbot-messages .msg").last().find(".msg-text"),r=0,c=setInterval(function(){s.html(o.convert(a.substring(0,r))),++r>a.length&&clearInterval(c);var t=e("#chatbot-messages")[0];t.scrollTop=t.scrollHeight},50)})},1e3),l=e("#chatbot-icon"),u=e("#chatbot-window"),h=e("#chatbot-close"),l.on("click",function(){u.toggleClass("hidden"),u.hasClass("hidden")?localStorage.setItem("chatbotSuppressed","1"):localStorage.removeItem("chatbotSuppressed")}),h.on("click",function(){u.addClass("hidden"),localStorage.setItem("chatbotSuppressed","1")}),e("#chatbot-send").on("click",d),e("#chatbot-text").on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),d())})})}}});