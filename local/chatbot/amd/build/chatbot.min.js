define(["jquery","core/templates","local_chatbot/markdown"],function(u,s,d){return{init:function(e){var r=e.userid,n=e.username,c=e.coursename,i=e.credits||0,e=M.util.image_url("logo","local_chatbot");function o(){var o,e,t,n,a,s=u("#chatbot-text").val().trim();s&&(i<=0?l("bot",M.str.local_chatbot.outofcredits):(u("#chatbot-text").val(""),l("user",s),e=["Understanding your question...","Formulating a response...","Referencing course modules..."],t=u("#chatbot-thinking"),n=0,a=setInterval(function(){t.text(e[n]),n=(n+1)%e.length},1e3),o=function(){clearInterval(a),t.text("")},u.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(e){var t;e&&void 0!==e.credits&&(i=e.credits,u("#chatbot-credits").text("Credits remaining: "+i)),t=function(e,t){l("bot",e||t),o(),console.log("Sent to backend",{text:s,userid:r,coursename:c})},u.ajax({url:M.cfg.wwwroot+"/local/chatbot/chatapi.php",method:"POST",dataType:"json",data:{sesskey:M.cfg.sesskey,message:s},success:function(e){e&&e.reply?t(null,e.reply):e&&e.error?t(e.error):t("Invalid response from server")},error:function(e){e=e.responseText||e.statusText||"Unknown error";t("Error: "+e)}})},"json")))}function l(e,t){var o="bot"===e?"sidGuru":n;t="bot"===e?d.convert(t):d.escapeHtml(t),s.render("local_chatbot/message",{sender:e,text:t,sendername:o}).done(function(e){u("#chatbot-messages").append(e),s.runTemplateJS(e);e=u("#chatbot-messages")[0];e.scrollTop=e.scrollHeight})}s.render("local_chatbot/chatbox",{iconurl:e}).done(function(e){var t;u("body").append(e),s.runTemplateJS(e),u("#chatbot-context").text(n+" ("+r+") - "+c),u("#chatbot-credits").text("Credits remaining: "+i),setTimeout(function(){var a;u("#chatbot-window").removeClass("hidden"),a="Hello! I'm SidGuru, your academic companion. I can answer questions, clear doubts, and even summarize course content. How may I assist you today?",s.render("local_chatbot/message",{sender:"bot",text:"",sendername:"sidGuru"}).done(function(e){u("#chatbot-messages").append(e),s.runTemplateJS(e);var t=u("#chatbot-messages .msg").last().find(".msg-text"),o=0,n=setInterval(function(){t.html(d.convert(a.substring(0,o))),++o>a.length&&clearInterval(n);var e=u("#chatbot-messages")[0];e.scrollTop=e.scrollHeight},50)})},1e3),e=u("#chatbot-icon"),t=u("#chatbot-window"),n=u("#chatbot-close"),e.on("click",function(){t.toggleClass("hidden")}),n.on("click",function(){t.addClass("hidden")}),u("#chatbot-send").on("click",o),u("#chatbot-text").on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),o())})})}}});
