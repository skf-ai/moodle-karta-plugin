define(["jquery","core/templates","local_chatbot/markdown"],function(t,e,o){return{init:function(n){var r=n.userid,c=n.username,a=n.coursename,s=n.credits||0,i=M.util.image_url("logo","local_chatbot");function l(){var e=t("#chatbot-text").val().trim();e&&(s<=0?u("bot",M.str.local_chatbot.outofcredits):(t("#chatbot-text").val(""),u("user",e),function(e){var o=["Understanding your question...","Formulating a response...","Referencing course modules..."],n=t("#chatbot-thinking"),r=0;function c(){r<o.length?(n.text(o[r]),r++,setTimeout(c,1e3)):(n.text(""),e())}c()}(function(){t.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(o){var n,c;o&&void 0!==o.credits&&(s=o.credits,t("#chatbot-credits").text("Credits remaining: "+s)),n=e,c=function(t,o){u("bot",t||o),console.log("Sent to backend",{text:e,userid:r,coursename:a})},t.ajax({url:M.cfg.wwwroot+"/local/chatbot/chatapi.php",method:"POST",dataType:"json",data:{sesskey:M.cfg.sesskey,message:n},success:function(t){t&&t.reply?c(null,t.reply):t&&t.error?c(t.error):c("Invalid response from server")},error:function(t){var e=t.responseText||t.statusText||"Unknown error";c("Error: "+e)}})},"json")})))}function u(n,r){var a="bot"===n?"sid":c;r="bot"===n?o.convert(r):o.escapeHtml(r),e.render("local_chatbot/message",{sender:n,text:r,sendername:a}).done(function(o){t("#chatbot-messages").append(o),e.runTemplateJS(o);var n=t("#chatbot-messages")[0];n.scrollTop=n.scrollHeight})}e.render("local_chatbot/chatbox",{iconurl:i}).done(function(o){var n,i;t("body").append(o),e.runTemplateJS(o),t("#chatbot-context").text(c+" ("+r+") - "+a),t("#chatbot-credits").text("Credits remaining: "+s),n=t("#chatbot-icon"),i=t("#chatbot-window"),n.on("click",function(){i.toggleClass("hidden")}),t("#chatbot-send").on("click",l),t("#chatbot-text").on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),l())})})}}});
