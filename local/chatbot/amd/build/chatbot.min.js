define(["jquery","core/templates","local_chatbot/markdown"],function(u,r,c){return{init:function(t){var a=t.userid,n=t.username,s=t.coursename,i=t.credits||0,t=M.util.image_url("logo","local_chatbot");function o(){var o,t,e,n,r,c=u("#chatbot-text").val().trim();c&&(i<=0?l("bot",M.str.local_chatbot.outofcredits):(u("#chatbot-text").val(""),l("user",c),t=["Understanding your question...","Formulating a response...","Referencing course modules..."],e=u("#chatbot-thinking"),n=0,r=setInterval(function(){e.text(t[n]),n=(n+1)%t.length},1e3),o=function(){clearInterval(r),e.text("")},u.post(M.cfg.wwwroot+"/local/chatbot/updatecredit.php",{sesskey:M.cfg.sesskey},function(t){var e;t&&void 0!==t.credits&&(i=t.credits,u("#chatbot-credits").text("Credits remaining: "+i)),e=function(t,e){l("bot",t||e),o(),console.log("Sent to backend",{text:c,userid:a,coursename:s})},u.ajax({url:M.cfg.wwwroot+"/local/chatbot/chatapi.php",method:"POST",dataType:"json",data:{sesskey:M.cfg.sesskey,message:c},success:function(t){t&&t.reply?e(null,t.reply):t&&t.error?e(t.error):e("Invalid response from server")},error:function(t){t=t.responseText||t.statusText||"Unknown error";e("Error: "+t)}})},"json")))}function l(t,e){var o="bot"===t?"sidGuru":n;e="bot"===t?c.convert(e):c.escapeHtml(e),r.render("local_chatbot/message",{sender:t,text:e,sendername:o}).done(function(t){u("#chatbot-messages").append(t),r.runTemplateJS(t);t=u("#chatbot-messages")[0];t.scrollTop=t.scrollHeight})}r.render("local_chatbot/chatbox",{iconurl:t}).done(function(t){var e;u("body").append(t),r.runTemplateJS(t),u("#chatbot-context").text(n+" ("+a+") - "+s),u("#chatbot-credits").text("Credits remaining: "+i),l("bot","Hi I am SidGuru please let me know if you have any questions relevant to the course"),t=u("#chatbot-icon"),e=u("#chatbot-window"),t.on("click",function(){e.toggleClass("hidden"),e.hasClass("hidden")?e.removeClass("expanded"):e.addClass("expanded")}),u("#chatbot-send").on("click",o),u("#chatbot-text").on("keydown",function(t){"Enter"!==t.key||t.shiftKey||(t.preventDefault(),o())})})}}});
